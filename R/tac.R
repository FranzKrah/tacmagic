##################################
## tacmagic - PET Analysis in R ##
## tac.R                        ##
## (C) Eric E. Brown  2018      ##
## Beta version--check all work ##
##################################

#' Calculate weighted time-activity curves for specified regions of interest
#'
#'@export
#'@param tac The time-activity curve data from loading function
#'@param volumes The ROI volume data from loading function
#'@param ROI_def The definition of ROIs by combining smaller ROIs from TAC file
#'@param merge If TRUE, includes the original ROIs in the output data
#'@param PVC If TRUE, appends "_C" to ROI name header (as in PMOD TAC files)
#'@return Time-activity curves for the specified ROIs
#examples tac_roi(p1tac, p1vol, standardROIs(), merge=T)
tac_roi <- function(tac, volumes, ROI_def, merge, PVC) {
    
  if(!validate_tac(tac)) stop("Supplied tac file did not validate.")

  ROI_PVC <- ROI_def
    
  if (PVC) {
      for (i in 1:length(ROI_PVC)) {
        ROI_PVC[i] <- lapply(ROI_PVC[i], paste, "_C", sep="")
      }
  }
    
  # Setup the output data.frame
  m <- matrix(nrow=length(tac[,1]), ncol=length(ROI_def))
  calculated_TACs <- as.data.frame(m)
  names(calculated_TACs) <- names(ROI_def)

  # Calculate the weighted mean TACs for each ROI in the definition list
  for (i in 1:length(ROI_def)) {
      calculated_TACs[i] <- apply(tac[,ROI_PVC[[i]]], 1, weighted.mean,
                                  volumes[ROI_def[[i]],])
  }
    
  if (merge) {
    calculated_TACs <- data.frame(tac, calculated_TACs)
  } else {
      calculated_TACs <- data.frame(tac[1:2], calculated_TACs)
  }
  
  attributes(calculated_TACs)$time_unit <- attributes(tac)$time_unit
  attributes(calculated_TACs)$activity_unit <- attributes(tac)$activity_unit
  attributes(calculated_TACs)$tm_type <- "tac"

  if(!validate_tac(calculated_TACs)) stop("Merged ROI tac file did not validate.")

  return(calculated_TACs)
}

#' Plots time activity curves from 1 or 2 participants or groups.
#'
#'@export
#'@param TACtable1 (e.g. from tac_roi() or load_tac())
#'@param TACtable2 An optional, second TAC, to plot for comparison
#'@param ROIs A vector of ROIs to plot, names matching the TAC headers
#'@param ymax The maximum value on the y-axis
#'@param time "seconds" or "minutes" depending on desired x-axis, converts tac
#'@param title A title for the plot
#'@return Creates a plot.
plot_tac <- function(TACtable1, TACtable2=NULL, ROIs, ymax=25, 
                     time="minutes", title="") {
  
  if (!validate_tac(TACtable1)) stop("The 1st tac object did not validate.")
  if (!is.null(TACtable2)) {
    if (!validate_tac(TACtable2)) stop("The 2nd tac object did not validate.")
  }
  
  if (!(time %in% c("seconds", "minutes"))) stop("Time must be \"seconds\" or 
                                                 \"minutes\"")

  if (time == "minutes") {
    if (attributes(TACtable1)$time_unit == "minutes") time_conversion <- 1
    if (attributes(TACtable1)$time_unit == "seconds") time_conversion <- 60
  }

  if (time == "seconds") {
    if (attributes(TACtable1)$time_unit == "seconds") time_conversion <- 1
    if (attributes(TACtable1)$time_unit == "minutes") time_conversion <- 1/60
  }

  # Sets up the plot using the frame start from the TAC file for the x axis
  # and converting to minutes if chosen. 
   
  plot(1,type='n',
       xlim=c(TACtable1$start[1],
              TACtable1$start[length(TACtable1$start)]/time_conversion),
              ylim=c(0,ymax),
              xlab=paste0("Time (", time, ")"),
              ylab=paste0("Activity (", 
                          attributes(TACtable1)$activity_unit, ")"),
              main=title)
  
  # Separate colour ranges for each group of TACs
  colour1 <- rainbow(length(ROIs), start=0, end=0.25)
  colour2 <- rainbow(length(ROIs), start=0.5, end=0.8)
  
  # Plots the ROIs as specified in the ROIs argument
  index <- c(1:length(ROIs))
  for (ROI in index) {

    lines(x=TACtable1$start/time_conversion, 
          y=TACtable1[,ROIs[ROI]], 
          type='o', 
          col=colour1[ROI], 
          lwd=2)
    
    # Only if 2nd TAC table is provided, plots second on same plot
    if (is.data.frame(TACtable2)) {
      lines(x=TACtable2$start/time_conversion, 
            y=TACtable2[,ROIs[ROI]], 
            type='o', 
            col=colour2[ROI], 
            lwd=2)
    }
  }
  
  legend("topright", legend=ROIs, col=colour1, pch=1)
  if (is.data.frame(TACtable2)) {
    legend("bottomright", legend=ROIs, col=colour2, pch=1)
  }
} 
